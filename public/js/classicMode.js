import{onAuthStateChanged as t}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";import{pokemons as e}from"./pokemons.js";import{classicAppState as i}from"./classicAppState.js";import{animateFadeIn as a,auth as n}from"./auth.js";"Notification"in window&&Notification.requestPermission(t=>{"granted"!=t?console.log("Notifications: no permission"):console.log("Notifications: enabled")});let timer=document.getElementById("timer"),subtitle=document.getElementById("subtitle"),containerbar=document.getElementById("textbar-container"),textbar=document.getElementById("textbar"),guessButton=document.getElementById("guess-button"),containerstate=document.getElementById("state-container"),containertitles=document.getElementById("titles-container"),classicState=new i;null==classicState.getUserID()&&await axios.get("/user/id").then(t=>{classicState.setUserID(t.data)});let userID=classicState.getUserID();function manageGameState(t,e){var i=classicState.getGameID();(null==i||i!=t)&&(classicState.setGameID(t),classicState.removeState()),classicState.notRendered()&&classicState.getTries()>0&&a(containertitles,"1.5s"),classicState.renderState(),setInterval(()=>{classicState.notRendered()&&classicState.getTries()>0&&a(containertitles,"1.5s"),classicState.renderStateDiff()},6e4),setTimeout(()=>{sendNotification("A new Pok\xe9mon is waiting for you!"),classicState.removeState(),window.location.reload()},e);var n=Math.floor(e/1e3),s=n%3600,r=Math.floor(n/3600),o=Math.floor(s/60),l=s%60;setInterval(()=>{(!(r<=0)||!(o<=0)||!(l<=0))&&(r>=1&&0==o&&0==l?(r--,o=59,l=59):o>=1&&0==l?(o--,l=59):l--,timer.innerHTML="Reset in<br />"+(r<10?"0"+r:r)+":"+(o<10?"0"+o:o)+":"+(l<10?"0"+l:l))},1e3)}function onVictory(t,e){var i=new Audio("public/audio/victory-sound.mp3");i.volume=.1,i.play(),setTimeout(()=>{var i=document.createElement("DIV");i.setAttribute("id","victory-ad-container"),subtitle.insertAdjacentElement("afterend",i),i.innerHTML=`<div id="victory-text1"><b>GG!</b></div><div id="victory-text2"><b>It was ${e.name} indeed!</b></div><div><img alt="" style="animation: fadeIn 500ms" src='/public/images/sprites/${e.name}.webp' width='180px' height='180px'></div><div id="victory-text3"><b>You guessed it in ${t} tries...</b></div><div id="victory-text4"><b>Think you can do better? Let's see!</b></div><a aria-label="Go to Home" href='/'><button id='continue-button'>Continue</button></a>`},1e3)}function initializeAutocomplete(t,e){function i(e){for(var i=document.getElementsByClassName("autocomplete-items"),a=0;a<i.length;a++)e!=i[a]&&e!=t&&i[a].parentNode.removeChild(i[a])}t.addEventListener("input",function(){var a=this.value;if(i(),!a)return!1;var n=document.createElement("DIV");n.setAttribute("id","autocomplete-list"),n.setAttribute("class","autocomplete-items"),this.parentNode.appendChild(n);for(var s=0;s<e.length;s++)if(e[s].substr(0,a.length).toUpperCase()==a.toUpperCase()){var r=document.createElement("DIV");r.className="list-options",r.innerHTML=`<img alt="" src='/public/images/sprites/${e[s]}.webp' width='70px' height='70px'><strong style="color: #8cff66;">${e[s].substr(0,a.length)}</strong>${e[s].substr(a.length)}<input type='hidden' value='${e[s]}'>`,r.addEventListener("click",function(){t.value=this.getElementsByTagName("input")[0].value,i()}),n.appendChild(r)}}),document.addEventListener("click",t=>{i(t.target)})}function triggerElementAnimation(t,e){for(;t.classList.length>0;)t.classList.remove(t.classList.item(0));t.offsetWidth,t.classList.add(e)}function sendNotification(t){"Notification"in window&&Notification.requestPermission().then(e=>{"granted"===e&&new Notification("Pok\xe9dle",{body:t,icon:"/public/images/icons/icon-192x192.webp"})})}axios.get("/classic/state").then(t=>{manageGameState(t.data[0],t.data[1],t.data[2])}),initializeAutocomplete(textbar,e),t(n,t=>{axios.get("/classic/canPlay/uid="+userID+"&gid="+(n.currentUser?n.currentUser.uid:null)).then(t=>{t.data?("block"==subtitle.style.display&&(triggerElementAnimation(subtitle,"fadeOut"),setTimeout(()=>subtitle.style.display="none",1150)),"none"==containerbar.style.display&&(triggerElementAnimation(containerbar,"fadeIn"),containerbar.style.display="block"),"none"==containerstate.style.display&&(triggerElementAnimation(containerstate,"fadeIn"),containerstate.style.display="block")):("none"==subtitle.style.display&&(triggerElementAnimation(subtitle,"fadeIn"),subtitle.style.display="block"),"block"==containerbar.style.display&&(triggerElementAnimation(containerbar,"fadeOut"),setTimeout(()=>containerbar.style.display="none",1150)),"block"==containerstate.style.display&&(triggerElementAnimation(containerstate,"fadeOut"),setTimeout(()=>containerstate.style.display="none",1150)))})}),guessButton.addEventListener("click",async()=>{var t=textbar.value;if(textbar.value="",""==t||!e.includes(t)){triggerElementAnimation(textbar,"shake");return}var i=null;null!=n.currentUser&&(i=await n.currentUser.getIdToken()),axios.post("/classic",{token:i,uid:userID,guess:t,tries:classicState.getTries()+1}).then(t=>{var e=t.data[0],i=t.data[2];classicState.notRendered()&&a(containertitles,"1.5s"),classicState.addGuess(t.data),i&&(textbar.disabled=!0,onVictory(classicState.getTries(),e),classicState.removeState())}).catch(t=>console.error(t))});