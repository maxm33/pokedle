import{initializeApp as t}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";import{getAuth as e,GoogleAuthProvider as n,onAuthStateChanged as i,signInWithPopup as a,signOut as s}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";import{pokemons as r}from"./pokemons.js";import{classicAppState as o}from"./classicAppState.js";Notification.requestPermission(t=>{"granted"!=t?console.log("Notifications: no permission"):console.log("Notifications: enabled")});let loginButton=document.getElementById("login-button"),profileButton=document.getElementById("profile-button"),pokedexButton=document.getElementById("pokedex-button"),rankingButton=document.getElementById("ranking-button"),guessButton=document.getElementById("guess-button"),prevtitle=document.getElementById("prev-title"),timer=document.getElementById("timer"),subtitle=document.getElementById("subtitle"),containertitles=document.getElementById("titles-container"),containerbar=document.getElementById("textbar-container"),containerstate=document.getElementById("state-container"),textbar=document.getElementById("textbar"),classicState=new o,provider=new n,config=await axios.get("/env/fb"),auth=e(t(config.data));null==classicState.getUserID()&&await axios.get("/user/id").then(t=>{classicState.setUserID(t.data)});let userID=classicState.getUserID();axios.get("/classic/state").then(t=>{manageGameState(t.data[0],t.data[1],t.data[2])}),initializeAutocomplete(textbar,r);let unsubscribe=i(auth,t=>{t?(loginButton.value="Logout",animateFadeIn(profileButton,"1s"),animateFadeIn(pokedexButton,"1s")):(loginButton.value="Login ",animateFadeOut(profileButton,"1.5s"),animateFadeOut(pokedexButton,"1.5s")),axios.get("/classic/canPlay/uid="+userID+"&gid="+(auth.currentUser?auth.currentUser.uid:null)).then(t=>{var e=`<p>I'm thinking of a <span style="color:#8cff66">Pok\xe9mon</span>, can you guess it?</p>`,n="<p>Don't move! Next will be legen... Wait for it...</p>";t.data?(subtitle.innerHTML!=e&&(triggerElementAnimation(subtitle,"fadeIn"),subtitle.innerHTML=e),"none"==containerbar.style.display&&(triggerElementAnimation(containerbar,"fadeIn"),containerbar.style.display="block"),"none"==containerstate.style.display&&(triggerElementAnimation(containerstate,"fadeIn"),containerstate.style.display="block")):(subtitle.innerHTML!=n&&(triggerElementAnimation(subtitle,"fadeIn"),subtitle.innerHTML=n),"block"==containerbar.style.display&&(triggerElementAnimation(containerbar,"fadeOut"),setTimeout(()=>containerbar.style.display="none",1150)),"block"==containerstate.style.display&&(triggerElementAnimation(containerstate,"fadeOut"),setTimeout(()=>containerstate.style.display="none",1150)))})});function manageGameState(t,e,n){null!=n&&(prevtitle.innerHTML='<p>Previous Pok\xe9mon was <span style="color:#ff6666">'+n.name+" #"+n.ID,animateFadeIn(prevtitle,"1.5s"));var i=classicState.getGameID();(null==i||i!=t)&&(classicState.setGameID(t),classicState.removeState()),classicState.notRendered()&&classicState.getTries()>0&&animateFadeIn(containertitles,"1.5s"),classicState.renderState(),setInterval(()=>{classicState.notRendered()&&classicState.getTries()>0&&animateFadeIn(containertitles,"1.5s"),classicState.renderStateDiff()},6e4),setTimeout(()=>{sendNotification("A new Pok\xe9mon is waiting for you!"),classicState.removeState(),window.location.reload()},e);var a=Math.floor(e/1e3),s=a%3600,r=Math.floor(a/3600),o=Math.floor(s/60),l=s%60;setInterval(()=>{(!(r<=0)||!(o<=0)||!(l<=0))&&(r>=1&&0==o&&0==l?(r--,o=59,l=59):o>=1&&0==l?(o--,l=59):l--,timer.textContent="A new Pok\xe9mon is spawning in "+(r<10?"0"+r:r)+":"+(o<10?"0"+o:o)+":"+(l<10?"0"+l:l))},1e3)}function onVictory(t,e){var n=new Audio("public/audio/victory-sound.mp3");n.volume=.1,n.play(),setTimeout(()=>{var n=document.createElement("DIV");n.setAttribute("id","victory-ad-container"),subtitle.insertAdjacentElement("afterend",n),n.innerHTML=`<div id="victory-text1"><b>GG!</b></div><div id="victory-text2"><b>It was ${e.name} indeed!</b></div><div><img alt="" style="animation: fadeIn 500ms" src='/public/images/sprites/${e.name}.webp' width='180px' height='180px'></div><div id="victory-text3"><b>You guessed it in ${t} tries...</b></div><div id="victory-text4"><b>Think you can do better? Let's see!</b></div><a aria-label="Go to Home" href='/'><button id='continue-button'>Continue</button></a>`},1e3)}function initializeAutocomplete(t,e){function n(e){for(var n=document.getElementsByClassName("autocomplete-items"),i=0;i<n.length;i++)e!=n[i]&&e!=t&&n[i].parentNode.removeChild(n[i])}t.addEventListener("input",function(){var i=this.value;if(n(),!i)return!1;var a=document.createElement("DIV");a.setAttribute("id","autocomplete-list"),a.setAttribute("class","autocomplete-items"),this.parentNode.appendChild(a);for(var s=0;s<e.length;s++)if(e[s].substr(0,i.length).toUpperCase()==i.toUpperCase()){var r=document.createElement("DIV");r.className="list-options",r.innerHTML=`<img alt="" src='/public/images/sprites/${e[s]}.webp' width='70px' height='70px'><strong style="color: lightgreen;">${e[s].substr(0,i.length)}</strong>${e[s].substr(i.length)}<input type='hidden' value='${e[s]}'>`,r.addEventListener("click",function(){t.value=this.getElementsByTagName("input")[0].value,n()}),a.appendChild(r)}}),document.addEventListener("click",t=>{n(t.target)})}function animateFadeIn(t,e){t.style.animation="fadeIn "+e,t.style.visibility="visible"}function animateFadeOut(t,e){t.style.animation="fadeOut "+e,setTimeout(()=>t.style.visibility="hidden",1150)}function triggerElementAnimation(t,e){for(;t.classList.length>0;)t.classList.remove(t.classList.item(0));t.offsetWidth,t.classList.add(e)}function sendNotification(t){"Notification"in window&&Notification.requestPermission().then(e=>{"granted"===e&&new Notification("Pok\xe9dle",{body:t,icon:"/public/images/icon-192x192.webp"})})}loginButton.addEventListener("click",()=>{unsubscribe(),auth.currentUser?s(auth).then(()=>{window.location.reload()}):a(auth,provider).then(()=>{auth.currentUser.getIdToken().then(t=>{axios.put("/user/"+auth.currentUser.uid,{name:auth.currentUser.displayName,token:t}),window.location.reload()})})}),profileButton.addEventListener("click",()=>{window.location.href=`/user/${auth.currentUser.uid}/profile`}),pokedexButton.addEventListener("click",()=>{window.location.href=`/user/${auth.currentUser.uid}/pokedex`}),rankingButton.addEventListener("click",()=>{window.location.href="/classic/ranking"}),guessButton.addEventListener("click",async()=>{var t=textbar.value;if(textbar.value="",""==t||!r.includes(t)){triggerElementAnimation(textbar,"shake");return}var e=null;null!=auth.currentUser&&(e=await auth.currentUser.getIdToken()),axios.post("/classic",{token:e,uid:userID,guess:t,tries:classicState.getTries()+1}).then(t=>{var e=t.data[0],n=t.data[2];classicState.notRendered()&&animateFadeIn(containertitles,"1.5s"),classicState.addGuess(t.data),n&&(textbar.disabled=!0,onVictory(classicState.getTries(),e),classicState.removeState())}).catch(t=>console.error(t))});